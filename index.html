<!DOCTYPE html>
<html>
    <head>
        <title>the lol shmup</title>
        <style>
            canvas {
                border: 1px solid black;
            }
        </style>
        <script>
//header

var GAME = {
    canvas: document.createElement("canvas"),
    start: function(){
        this.canvas.width = 1200;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
    },
    activate: function(){
        this.frameCount = 0;
        this.interval = setInterval(main, 20);
        GAME.DATE = new Date();
        console.log("Nuclear Cuke");
    },
    clear: function(){
        this.context.clearRect(0, 0, this.canvas.width * 2, this.canvas.height * 2);
    },
    gravity: 1,
    friction: 0.9,
    level: 1,
    camera: {x:0, y:0},
    editingMode: true,
    debugMode: false,
    DATE: new Date(),
}
function colorToList(color){
    return [
        parseInt(color.slice(1, 3), 16),
        parseInt(color.slice(3, 5), 16),
        parseInt(color.slice(5, 7), 16)];
}
function listToColor(color){
    return "#" + ("0"+(Number(color[0]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[1]).toString(16))).slice(-2).toUpperCase() +
                ("0"+(Number(color[2]).toString(16))).slice(-2).toUpperCase();
}

function Entity(X, Y, W, H){
    this.pPosition = {x: X, y: Y};
    this.position = {x: X, y: Y};
    this.velocity = {x: 0, y: 0};
    this.width = W;
    this.height = H;
    this.dead = false;
    this.rotation = 0;
    this.invinciTimer = 0;
}
Entity.prototype.move = function(){
    this.position.x += this.velocity.x;
    this.position.y += this.velocity.y;
}
Entity.prototype.applyFriction = function(){
    this.velocity.x *= GAME.friction;
    this.velocity.y *= GAME.friction;
}
Entity.prototype.applyGravity = function(){
    this.velocity.y += GAME.gravity;
}
Entity.prototype.draw = function(){
    var CTX = GAME.context;
    CTX.fillStyle = "#FF0000";
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.restore();
}
Entity.prototype.applyForce = function(x, y){
    this.velocity.x += x;
    this.velocity.y += y;
}
Entity.prototype.collides = function(obj){
    if(obj instanceof Entity){
        return (this.position.x + this.width > obj.position.x &&
            this.position.x < obj.position.x + obj.width &&
            this.position.y + this.height > obj.position.y &&
            this.position.y < obj.position.y + obj.height);
    }
    return false;
}
Entity.prototype.centerPosition = function(){
    var CTX = GAME.context;
    CTX.save();
    CTX.translate(this.position.x - GAME.camera.x,
                this.position.y - GAME.camera.y);
    CTX.rotate(this.rotation);
}
Entity.prototype.onScreen = function(){
    return (this.position.x - GAME.camera.x + this.width > 0 &&
    this.position.x - GAME.camera.x < GAME.canvas.width &&
    this.position.y - GAME.camera.y + this.height > 0 &&
    this.position.y - GAME.camera.y < GAME.canvas.height);
}
Entity.prototype.interact = function(obj){ /*method stub*/ }

function Particle(X, Y, W, H, color, duration=10){
    Entity.call(this, X, Y, W, H);
    this.color = color;
    this.duration = duration;
    this.velocity = {x: 0, y: 0};
    this.angularVelocity = Math.random() * 10 - 5;
}
Particle.prototype = Object.create(Entity.prototype);
Particle.prototype.setDuration = function(frames){ this.duration = frames; }
Particle.prototype.setVelocity = function(xVel, yVel){ this.velocity = {x: xVel, y: yVel}; }
Particle.prototype.setAngularVelocity = function(r){ this.angularVelocity = r; }
Particle.prototype.update = function(){
    this.move();
    this.applyFriction();
    this.angularVelocity *= GAME.friction;
    this.draw();
    if(this.duration <= 0){
        this.dead = true;
    }
    this.rotation += this.angularVelocity;
    this.duration--;
}
Particle.prototype.draw = function(){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.restore();
}

function Bullet(X, Y, W, H, color=[0, 0, 0]){
    Entity.call(this, X, Y, W, H);
    this.color = color; //list format
}
Bullet.prototype = Object.create(Entity.prototype);
Bullet.prototype.setVelocity = function(xVel, yVel){ this.velocity = {x: xVel, y: yVel}; }
Bullet.prototype.setUser = function(usr){ this.user = usr; }
Bullet.prototype.update = function(){
    this.move();
    this.draw();
    if(!this.onScreen()){
        this.dead = true;
    }
}
Bullet.prototype.draw = function(){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.restore();
}
Bullet.prototype.typeCheck = function(obj){
    if(obj instanceof Player || obj instanceof Enemy){
        var userP = (this.user) instanceof Player;
        var userE = (this.user) instanceof Enemy;
        var objP = obj instanceof Player;
        var objE = obj instanceof Enemy;
        if((userP && objE || userE && objP || this.user === null) && 
        this.collides(obj) && obj.invinciTimer <= 0){
            return true;
        }
    }
    return false;
}
Bullet.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        obj.hp--;
        if(obj instanceof Player){
            obj.invinciTimer = 75;
        }
        this.dead = true;
        var particles = [];
        for(var i = 0; i < 12; i++){
            particles.push(new Particle(
                this.position.x + this.width/2,
                this.position.y + this.height/2,
                8, 2, [100, 0, 0], 20));
            particles[i].setVelocity(Math.random() * 20 - 10,
                                    Math.random() * 20 - 10);
            entities.push(particles[i]);
        }
    }
}

function PowerBullet(X, Y){
    Bullet.call(this, X, Y, 50, 8);
    this.color = [0, 255, 0];
}
PowerBullet.prototype = Object.create(Bullet.prototype);
PowerBullet.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        obj.hp -= 5;
        this.dead = true;
        var particles = [];
        for(var i = 0; i < 16; i++){
            particles.push(new Particle(
                this.position.x + this.width/2,
                this.position.y + this.height/2,
                20, 10, [100, 0, 100], 20));
            particles[i].setVelocity(Math.random() * 30 - 15,
                                    Math.random() * 30 - 15);
            entities.push(particles[i]);
        }
    }
}

function Firework(X, Y){
    Bullet.call(this, X, Y, 20, 20);
    this.color = [0, 0, 0];
    this.delayTimer = 30;
}
Firework.prototype = Object.create(Bullet.prototype);
Firework.prototype.update = function(){
    Bullet.prototype.update.call(this);
    if(this.delayTimer <= 0){
        for(var i = 0; i < 2 * Math.PI; i += Math.PI/6){
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 8, 8,
                                [0, 0, 255]);
            b.setUser(this.user);
            b.setVelocity(12 * Math.cos(i), 12 * Math.sin(i));
            entities.push(b);
        }
        this.dead = true;
    }
    this.delayTimer--;
}
Firework.prototype.interact = function(obj){
    if(this.typeCheck(obj)){
        obj.hp -= 0.5;
        this.dead = true;
    }
}

function Shield(X, Y){
    Bullet.call(this, X, Y, 80, 80);
    this.color = [0, 100, 255];
    this.delayTimer = 30;
}
Shield.prototype = Object.create(Bullet.prototype);
Shield.prototype.draw = function(obj){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.globalAlpha = 0.5;
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.globalAlpha = 1;
    CTX.restore();
}
Shield.prototype.update = function(){
    Bullet.prototype.update.call(this);
    if(this.delayTimer <= 0){
        this.dead = true;
    }
    this.delayTimer--;
}
Shield.prototype.interact = function(obj){
    if(obj instanceof Bullet && this.collides(obj) &&
    obj.user != this.user){
        obj.dead = true;
        var particles = [];
        for(var i = 0; i < 10; i++){
            particles.push(new Particle(
                obj.position.x + obj.width/2,
                obj.position.y + obj.height/2,
                8, 2, [100, 0, 0], 20));
            particles[i].setVelocity(Math.random() * 10 - 5,
                                    Math.random() * 10 - 5);
            entities.push(particles[i]);
        }
    }
    if(obj instanceof Player && (this.user) instanceof Player){
        this.position.x = obj.position.x + obj.width/2 - this.width/2;
        this.position.y = obj.position.y + obj.height/2 - this.height/2;
    }
}

function Enemy(X, Y, W, H){
    Entity.call(this, X, Y, W, H);
    this.color = [0, 0, 0];
    this.hp = 1;
    this.velocity = {x: -1, y: 0};
}
Enemy.prototype = Object.create(Entity.prototype);
Enemy.prototype.update = function(){
    this.move();
    this.draw();
    if(this.position.x < -100 || this.position.x > GAME.canvas.width + 100
    || this.hp <= 0){
        this.dead = true;
    }
}
Enemy.prototype.draw = function(){
    var CTX = GAME.context;
    this.centerPosition();
    CTX.fillStyle = listToColor(this.color);
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.restore();
}
Enemy.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.collides(obj) && obj.invinciTimer <= 0){
            obj.hp--;
            obj.invinciTimer = 75;
        }
    }
}

function Bat(X, Y, variant=1){
    Enemy.call(this, X, Y, 30, 30);
    this.color = [0, 0, 0];
    this.hp = 1;
    this.velocity = {x: -8, y: 0};
    this.variant = variant;
}
Bat.prototype = Object.create(Enemy.prototype);
Bat.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.variant > 1){
            if(Math.abs(this.position.y - obj.position.y) < 100){
                this.applyForce(0, -Math.sign(this.position.y - obj.position.y));
            }
            if(this.position.y < 0 || this.position.y > GAME.canvas.height){
                this.velocity.y *= -1;
            }
            if(this.variant > 2){
                if(this.position.x < obj.position.x){
                    this.applyForce(0.5, 0);
                }else{
                    this.applyForce(-0.1, 0);
                }
            }
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Lost(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [0, 0, 0];
    this.hp = 3;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    if(this.variant > 1){
        this.hp = 5;
    }
}
Lost.prototype = Object.create(Enemy.prototype);
Lost.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    Enemy.prototype.update.call(this);
}
Lost.prototype.interact = function(obj){
    if(obj instanceof Player){
        var dx = obj.position.x - this.position.x;
        var dy = obj.position.y - this.position.y;
        var mag = Math.sqrt(dx ** 2 + dy ** 2);
        this.applyForce(0.25 * dx/mag, 0.25 * dy/mag);
        if(this.delayTimer >= 125){
            this.delayTimer = 0;
            var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
            b.setUser(this);
            b.setVelocity(6 * dx/mag, 6 * dy/mag);
            entities.push(b);
        }
        if(mag < 200 && mag > 175 && this.variant > 2){
            this.applyForce(15 * dx/mag, 15 * dy/mag);
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function CrossShot(X, Y, variant=1){
    Enemy.call(this, X, Y, 40, 40);
    this.color = [255, 128, 0];
    this.hp = 3;
    this.velocity = {x: 0, y: 0};
    this.variant = variant;
    this.delayTimer = 0;
    if(this.variant > 1){
        this.hp = 5;
    }
}
CrossShot.prototype = Object.create(Enemy.prototype);
CrossShot.prototype.update = function(){
    this.applyFriction();
    this.delayTimer++;
    if(this.delayTimer % 10 == 0 && this.delayTimer > 100){
        var b = new Bullet(this.position.x + this.width/2,
                        this.position.y + this.height/2, 10, 10);
        b.setUser(this);
        b.setVelocity(-8, 0);
        entities.push(b);
        if(this.delayTimer == 150 || this.variant == 3){
            for(var i = 3 * Math.PI/4; i < 11 * Math.PI/8; i += Math.PI/8){
                var b = new Bullet(this.position.x + this.width/2,
                                this.position.y + this.height/2, 10, 10);
                b.setUser(this);
                b.setVelocity(8 * Math.cos(i), 8 * -Math.sin(i));
                entities.push(b);
            }
        }
    }
    if(this.delayTimer > 150){
        this.delayTimer = 0;
    }
    Enemy.prototype.update.call(this);
}
CrossShot.prototype.interact = function(obj){
    if(obj instanceof Player){
        if(this.delayTimer < 50){
            this.applyForce(-0.3, 1 * Math.sin(this.delayTimer/25 * 2 * Math.PI));
        }
    }
    Enemy.prototype.interact.call(this, obj);
}

function Player(X, Y, W, H){
    Entity.call(this, X, Y, W, H);
    this.goingLeft = false;
    this.goingRight = false;
    this.goingUp = false;
    this.goingDown = false;
    this.delayTimer = 0;
    this.hp = 3;
    this.invinciTimer = 0;
}
Player.prototype = Object.create(Entity.prototype);
Player.prototype.update = function(){
    if(this.goingLeft){
        this.applyForce(-0.75, 0);
    }
    if(this.goingRight){
        this.applyForce(0.75, 0);
    }
    if(this.goingUp){
        this.applyForce(0, -0.75);
    }
    if(this.goingDown){
        this.applyForce(0, 0.75);
    }
    if(this.delayTimer < 100){
        this.delayTimer++;
    }
    if(this.invinciTimer > 0){
        this.invinciTimer--;
    }
    //GAME.camera.x = this.position.x - GAME.canvas.width/2 + this.width/2;
    //GAME.camera.y = this.position.y - GAME.canvas.height/2 + this.height/2;
    //console.log(player.velocity.y);
    this.move();
    this.applyFriction();
    this.draw();
}
Player.prototype.draw = function(){
    var CTX = GAME.context;
    var color = [255, 0, 0];
    if(this.invinciTimer > 0){
        color = [255, this.invinciTimer % 2 * 255, this.invinciTimer % 2 * 255];
    }
    CTX.fillStyle = listToColor(color);
    CTX.fillRect(0, 0, this.width, this.height);
    CTX.restore();
}
function drawForeground(){
    var CTX = GAME.context;
    CTX.fillStyle = "#FF0000";
    CTX.fillRect(15, 15, player.delayTimer * 2, 15);
    for(var i = 0; i < player.hp; i++){
        CTX.fillRect(15 + 20 * i, 50, 15, 15);
    }
    if(player.hp <= 0){
        clearInterval(GAME.interval);
        alert("GAME OVER!");
    }
}
var entities = [];
var player = new Player(0, 0, 30, 30);
var initTime = 0;
document.onkeydown = function(e){
    e = e || window.event;
    if(e.keyCode == 37){ //Left
        player.goingLeft = true;
    }
    if(e.keyCode == 39){ //Right
        player.goingRight = true;
    }
    if(e.keyCode == 38){ //Up
        player.goingUp = true;
    }
    if(e.keyCode == 40){ //Down
        player.goingDown = true;
    }
    if(e.keyCode == 16){ //Shift
        player.velocity.x *= -1;
        player.velocity.y *= -1;
    }
    if(e.keyCode == 90){ //Z, shoot primary weapon
        if(player.delayTimer > 25){
            var b = new Firework(player.position.x + player.width/2,
                            player.position.y + player.height/2);
            b.setUser(player);
            b.setVelocity(12, 0);
            entities.push(b);
            player.delayTimer -= 25;
        }
    }
    if(e.keyCode == 88){ //X, shoot secondary weapon
        if(player.delayTimer > 30){
            var b = new PowerBullet(player.position.x + player.width/2,
                            player.position.y + player.height/2);
            b.setUser(player);
            b.setVelocity(15, 0);
            entities.push(b);
            player.delayTimer -= 30;
        }
    }
    if(e.keyCode == 67){ //C, shoot tertiary weapon
        if(player.delayTimer > 40){
            var s = new Shield(player.position.x, player.position.y);
            s.setUser(player);
            player.invinciTimer = 30;
            entities.push(s);
            player.delayTimer -= 40;
        }
    }
}
document.onkeyup = function(e){
    e = e || window.event;
    if(e.keyCode == 37){ //Left
        player.goingLeft = false;
    }
    if(e.keyCode == 39){ //Right
        player.goingRight = false;
    }
    if(e.keyCode == 38){ //Up
        player.goingUp = false;
    }
    if(e.keyCode == 40){ //Down
        player.goingDown = false;
    }
}
function init(){
    GAME.start();
    GAME.activate();
}
function spawnEnemies(){
    if(GAME.frameCount % 500 == 0){
        entities.push(new CrossShot(1199, Math.random() * 550, 3));
    }
    if(GAME.frameCount % 150 == 0){
        entities.push(new Bat(1199, Math.random() * 550, 3));
    }
    if(GAME.frameCount % 250 == 0){
        entities.push(new Lost(1199, Math.random() * 550, 3));
    }
}
function main(){
    GAME.clear();
    GAME.context.fillStyle = "#FFFFFF";
    GAME.context.fillRect(-GAME.canvas.width * 3, -GAME.canvas.height * 3,
    GAME.canvas.width * 6, GAME.canvas.height * 6);
    player.centerPosition();
    player.update();
    for(var i in entities){
        if(entities[i] instanceof Entity){
            entities[i].update();
            entities[i].draw();
            entities[i].interact(player);
            if(entities[i] instanceof Bullet){
                for(var j in entities){
                    entities[i].interact(entities[j]);
                }
            }
            if(entities[i].dead){
                entities.splice(i, 1);
                i--;
            }
        }
    }
    drawForeground();
    spawnEnemies();
    GAME.frameCount++;
}
//footer
        </script>
    </head>
    <body onload="init()">
        <div id="output"></div>
    </body>
</html>